<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pr√©dicteur Baccarat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { padding: 20px; background: #1a1a2e; color: white; font-family: Arial, sans-serif; }
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .admin-header { text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .admin-header h1 { margin: 0; font-size: 2em; }
        .admin-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .admin-stat-card { background: #16213e; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #0f3460; cursor: pointer; transition: transform 0.2s; }
        .admin-stat-card:hover { transform: translateY(-5px); background: #1a2a4e; }
        .admin-stat-card .value { font-size: 2em; font-weight: bold; color: #e94560; }
        .admin-stat-card .label { color: #aaa; margin-top: 5px; }
        
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: #16213e; border: 1px solid #0f3460; color: white; border-radius: 5px; cursor: pointer; }
        .tab-btn.active { background: #e94560; border-color: #e94560; }
        
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .users-table { width: 100%; border-collapse: collapse; background: #16213e; border-radius: 10px; overflow: hidden; }
        .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid #0f3460; }
        .users-table th { background: #0f3460; font-weight: bold; }
        .users-table tr:hover { background: #1a1a2e; }
        .user-actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-small { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .btn-add-1 { background: #28a745; color: white; }
        .btn-add-7 { background: #17a2b8; color: white; }
        .btn-add-30 { background: #ffc107; color: black; }
        .btn-block { background: #dc3545; color: white; }
        .btn-unblock { background: #6c757d; color: white; }
        .time-remaining { font-weight: bold; }
        .time-remaining.active { color: #28a745; }
        .time-remaining.expired { color: #dc3545; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 30px; border-radius: 5px; display: none; z-index: 1000; }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
    
    <div class="notification" id="notification"></div>
    
    <div class="admin-container">
        <div class="admin-header">
            <div style="width: 80px; height: 80px; margin: 0 auto 15px; background: white; border-radius: 15px; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                <img src="/static/logo.png?v={{ range(1, 100000) | random }}" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <h1>üîß Panneau Administrateur</h1>
            <p>{{ admin_email }}</p>
        </div>
        
        <div class="admin-stats" id="adminStats">
            <div class="admin-stat-card" onclick="switchView('users')">
                <div class="value" id="totalUsers">0</div>
                <div class="label">Utilisateurs</div>
            </div>
            <div class="admin-stat-card" onclick="switchView('active')">
                <div class="value" id="activeUsers">0</div>
                <div class="label">Actifs</div>
            </div>
            <div class="admin-stat-card" onclick="switchView('expired')">
                <div class="value" id="expiredUsers">0</div>
                <div class="label">Expir√©s</div>
            </div>
            <div class="admin-stat-card" onclick="switchView('predictions')">
                <div class="value" id="totalPredictions">0</div>
                <div class="label">Pr√©dictions</div>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" id="tab-users" onclick="switchView('users')">üë• Utilisateurs</button>
            <button class="tab-btn" id="tab-create" onclick="switchView('create')">‚ûï Cr√©er Compte</button>
            <button class="tab-btn" id="tab-predictions" onclick="switchView('predictions')">üîÆ Pr√©dictions</button>
        </div>

        <div id="users-section" class="view-section active">
            <h2>üìã Liste des utilisateurs</h2>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Mot de passe (Clair)</th>
                        <th>Inscription</th>
                        <th>Expiration</th>
                        <th>Temps restant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}" data-email="{{ user.email }}" data-active="{{ 'true' if user.is_active else 'false' }}">
                        <td>{{ user.id }}</td>
                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                        <td>{{ user.email }}</td>
                        <td style="font-family: monospace;">{{ user.plain_password or '********' }}</td>
                        <td>{{ user.created_at }}</td>
                        <td>{{ user.subscription_end or 'Jamais' }}</td>
                        <td class="time-remaining" data-end="{{ user.subscription_end }}">
                            Calcul...
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span style="color: #28a745;">‚úÖ Actif</span>
                            {% else %}
                                <span style="color: #dc3545;">üö´ Bloqu√©</span>
                            {% endif %}
                            {% if user.is_admin %}
                                <span style="color: #ffc107;">üëë Admin</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="user-actions">
                                <button class="btn-small btn-add-1" onclick="addTime('{{ user.email }}', 1)">+1j</button>
                                <button class="btn-small btn-add-7" onclick="addTime('{{ user.email }}', 7)">+7j</button>
                                <button class="btn-small btn-add-30" onclick="addTime('{{ user.email }}', 30)">+30j</button>
                                {% if user.is_active %}
                                <button class="btn-small btn-block" onclick="toggleBlock({{ user.id }}, true)">Bloquer</button>
                                {% else %}
                                <button class="btn-small btn-unblock" onclick="toggleBlock({{ user.id }}, false)">D√©bloquer</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="create-section" class="view-section">
            <div class="admin-header" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); margin-top: 20px;">
                <h2>‚ûï Cr√©er un compte manuel</h2>
                <form id="createUserForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 20px;">
                    <input type="text" id="newFirstName" placeholder="Pr√©nom" required style="padding: 10px; border-radius: 5px; border: none;">
                    <input type="text" id="newLastName" placeholder="Nom" required style="padding: 10px; border-radius: 5px; border: none;">
                    <input type="email" id="newEmail" placeholder="Email" required style="padding: 10px; border-radius: 5px; border: none;">
                    <input type="text" id="newPassword" placeholder="Mot de passe" required style="padding: 10px; border-radius: 5px; border: none;">
                    <button type="submit" class="btn-small btn-add-1" style="grid-column: 1 / -1; padding: 12px;">Cr√©er l'utilisateur</button>
                </form>
            </div>
        </div>

        <div id="predictions-section" class="view-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üîÆ Historique des Pr√©dictions</h2>
                <button class="btn-small btn-unblock" onclick="switchView('users')">‚¨ÖÔ∏è Retour</button>
            </div>
            <table class="users-table">
                <thead>
                    <tr>
                        <th>Jeu #</th>
                        <th>Type</th>
                        <th>R√©sultat</th>
                        <th>Statut</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="predictionsTableBody">
                    <!-- Rempli par JS -->
                </tbody>
            </table>
        </div>
    </div>
    </div>
    
    <script>
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.background = type === 'success' ? '#28a745' : '#dc3545';
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }
        
        function updateTimers() {
            document.querySelectorAll('.time-remaining').forEach(el => {
                const end = el.dataset.end;
                if (!end) {
                    el.textContent = 'Non abonn√©';
                    el.className = 'time-remaining expired';
                    return;
                }
                
                const endDate = new Date(end);
                const now = new Date();
                const diff = endDate - now;
                
                if (diff <= 0) {
                    el.textContent = 'EXPIR√â';
                    el.className = 'time-remaining expired';
                } else {
                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    el.textContent = `${days}j ${hours}h`;
                    el.className = 'time-remaining active';
                }
            });
        }
        
        async function addTime(email, days) {
            try {
                const res = await fetch('/api/admin/add-time', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, days})
                });
                
                if (res.ok) {
                    showNotification(`‚úÖ +${days} jours ajout√©s √† ${email}`);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await res.json();
                    showNotification(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (e) {
                showNotification(`‚ùå Erreur r√©seau`, 'error');
            }
        }
        
        async function toggleBlock(userId, block) {
            try {
                const action = block ? 'block' : 'unblock';
                const res = await fetch('/api/admin/block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action})
                });
                
                if (res.ok) {
                    showNotification(block ? 'üö´ Utilisateur bloqu√©' : '‚úÖ Utilisateur d√©bloqu√©');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await res.json();
                    showNotification(`‚ùå Erreur: ${data.error}`, 'error');
                }
            } catch (e) {
                showNotification(`‚ùå Erreur r√©seau`, 'error');
            }
        }
        
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            if (view === 'active') {
                document.getElementById('users-section').classList.add('active');
                document.getElementById('tab-users').classList.add('active');
                filterUsers('active');
            } else if (view === 'expired') {
                document.getElementById('users-section').classList.add('active');
                document.getElementById('tab-users').classList.add('active');
                filterUsers('expired');
            } else if (view === 'users') {
                document.getElementById('users-section').classList.add('active');
                document.getElementById('tab-users').classList.add('active');
                filterUsers('all');
            } else {
                document.getElementById(view + '-section').classList.add('active');
                document.getElementById('tab-' + view).classList.add('active');
            }
            
            if (view === 'predictions') {
                fetchPredictions();
            }
        }

        function filterUsers(type) {
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const timeCell = row.querySelector('.time-remaining');
                const isExpired = timeCell.textContent.includes('EXPIR√â') || timeCell.textContent.includes('Non abonn√©');
                const isActive = row.dataset.active === 'true';
                
                if (type === 'all') {
                    row.style.display = '';
                } else if (type === 'active') {
                    row.style.display = (isActive && !isExpired) ? '' : 'none';
                } else if (type === 'expired') {
                    row.style.display = isExpired ? '' : 'none';
                }
            });
        }

        async function fetchPredictions() {
            try {
                const res = await fetch('/api/predictions');
                if (res.ok) {
                    const data = await res.json();
                    const body = document.getElementById('predictionsTableBody');
                    body.innerHTML = '';
                    
                    data.predictions.reverse().forEach(p => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>#${p.game_number}</td>
                            <td>${p.suit}</td>
                            <td>${p.result || '-'}</td>
                            <td>${p.status}</td>
                            <td>${new Date(p.timestamp).toLocaleString()}</td>
                        `;
                        body.appendChild(tr);
                    });
                    
                    document.getElementById('totalPredictions').textContent = data.total_predictions;
                }
            } catch (e) {
                console.error('Erreur fetch predictions:', e);
            }
        }

        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location = '/login';
        }
        
        // Stats
        function updateStats() {
            const rows = document.querySelectorAll('#usersTableBody tr');
            let active = 0;
            let expired = 0;
            
            rows.forEach(row => {
                const timeCell = row.querySelector('.time-remaining');
                if (timeCell) {
                    if (timeCell.textContent.includes('EXPIR√â') || timeCell.textContent.includes('Non abonn√©')) {
                        expired++;
                    } else {
                        active++;
                    }
                }
            });
            
            document.getElementById('totalUsers').textContent = rows.length;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('expiredUsers').textContent = expired;
        }
        
        // Init
        updateTimers();
        updateStats();
        fetchPredictions(); // Get initial prediction count
        setInterval(updateTimers, 60000);
        
        // Rafra√Æchir les donn√©es toutes les 30 secondes
        setInterval(async () => {
            try {
                const res = await fetch('/api/admin/users');
                if (res.ok) {
                    const data = await res.json();
                    // Vous pouvez mettre √† jour le tableau ici sans recharger
                }
            } catch (e) {
                console.error('Erreur refresh:', e);
            }
        }, 30000);

        // Cr√©ation d'utilisateur
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                first_name: document.getElementById('newFirstName').value,
                last_name: document.getElementById('newLastName').value,
                email: document.getElementById('newEmail').value,
                password: document.getElementById('newPassword').value
            };
            
            try {
                const res = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    showNotification('‚úÖ Utilisateur cr√©√© avec succ√®s');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const err = await res.json();
                    showNotification('‚ùå Erreur: ' + (err.error || 'Inconnue'), 'error');
                }
            } catch (e) {
                showNotification('‚ùå Erreur r√©seau', 'error');
            }
        });
    </script>
</body>
</html>
