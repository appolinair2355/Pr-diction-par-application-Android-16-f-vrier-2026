<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - PrÃ©dicteur Baccarat</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        body { padding: 20px; background: #1a1a2e; color: white; font-family: Arial, sans-serif; }
        .admin-container { max-width: 1200px; margin: 0 auto; }
        .admin-header { text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .admin-header h1 { margin: 0; font-size: 2em; }
        .admin-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .admin-stat-card { background: #16213e; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #0f3460; }
        .admin-stat-card .value { font-size: 2em; font-weight: bold; color: #e94560; }
        .admin-stat-card .label { color: #aaa; margin-top: 5px; }
        .users-table { width: 100%; border-collapse: collapse; background: #16213e; border-radius: 10px; overflow: hidden; }
        .users-table th, .users-table td { padding: 12px; text-align: left; border-bottom: 1px solid #0f3460; }
        .users-table th { background: #0f3460; font-weight: bold; }
        .users-table tr:hover { background: #1a1a2e; }
        .user-actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .btn-small { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .btn-add-1 { background: #28a745; color: white; }
        .btn-add-7 { background: #17a2b8; color: white; }
        .btn-add-30 { background: #ffc107; color: black; }
        .btn-block { background: #dc3545; color: white; }
        .btn-unblock { background: #6c757d; color: white; }
        .time-remaining { font-weight: bold; }
        .time-remaining.active { color: #28a745; }
        .time-remaining.expired { color: #dc3545; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 15px 30px; border-radius: 5px; display: none; z-index: 1000; }
    </style>
</head>
<body>
    <button class="logout-btn" onclick="logout()">ðŸšª DÃ©connexion</button>
    
    <div class="notification" id="notification"></div>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>ðŸ”§ Panneau Administrateur</h1>
            <p>{{ admin_email }}</p>
        </div>
        
        <div class="admin-stats" id="adminStats">
            <div class="admin-stat-card">
                <div class="value" id="totalUsers">0</div>
                <div class="label">Utilisateurs</div>
            </div>
            <div class="admin-stat-card">
                <div class="value" id="activeUsers">0</div>
                <div class="label">Actifs</div>
            </div>
            <div class="admin-stat-card">
                <div class="value" id="expiredUsers">0</div>
                <div class="label">ExpirÃ©s</div>
            </div>
        </div>
        
        <h2>ðŸ“‹ Liste des utilisateurs</h2>
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Inscription</th>
                    <th>Expiration</th>
                    <th>Temps restant</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for user in users %}
                <tr data-user-id="{{ user.id }}" data-email="{{ user.email }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.first_name }} {{ user.last_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.created_at }}</td>
                    <td>{{ user.subscription_end or 'Jamais' }}</td>
                    <td class="time-remaining" data-end="{{ user.subscription_end }}">
                        Calcul...
                    </td>
                    <td>
                        {% if user.is_active %}
                            <span style="color: #28a745;">âœ… Actif</span>
                        {% else %}
                            <span style="color: #dc3545;">ðŸš« BloquÃ©</span>
                        {% endif %}
                        {% if user.is_admin %}
                            <span style="color: #ffc107;">ðŸ‘‘ Admin</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="user-actions">
                            <button class="btn-small btn-add-1" onclick="addTime('{{ user.email }}', 1)">+1j</button>
                            <button class="btn-small btn-add-7" onclick="addTime('{{ user.email }}', 7)">+7j</button>
                            <button class="btn-small btn-add-30" onclick="addTime('{{ user.email }}', 30)">+30j</button>
                            {% if user.is_active %}
                            <button class="btn-small btn-block" onclick="toggleBlock({{ user.id }}, true)">Bloquer</button>
                            {% else %}
                            <button class="btn-small btn-unblock" onclick="toggleBlock({{ user.id }}, false)">DÃ©bloquer</button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <script>
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.background = type === 'success' ? '#28a745' : '#dc3545';
            notif.style.display = 'block';
            setTimeout(() => {
                notif.style.display = 'none';
            }, 3000);
        }
        
        function updateTimers() {
            document.querySelectorAll('.time-remaining').forEach(el => {
                const end = el.dataset.end;
                if (!end) {
                    el.textContent = 'Non abonnÃ©';
                    el.className = 'time-remaining expired';
                    return;
                }
                
                const endDate = new Date(end);
                const now = new Date();
                const diff = endDate - now;
                
                if (diff <= 0) {
                    el.textContent = 'EXPIRÃ‰';
                    el.className = 'time-remaining expired';
                } else {
                    const days = Math.floor(diff / 86400000);
                    const hours = Math.floor((diff % 86400000) / 3600000);
                    el.textContent = `${days}j ${hours}h`;
                    el.className = 'time-remaining active';
                }
            });
        }
        
        async function addTime(email, days) {
            try {
                const res = await fetch('/api/admin/add-time', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, days})
                });
                
                if (res.ok) {
                    showNotification(`âœ… +${days} jours ajoutÃ©s Ã  ${email}`);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await res.json();
                    showNotification(`âŒ Erreur: ${data.error}`, 'error');
                }
            } catch (e) {
                showNotification(`âŒ Erreur rÃ©seau`, 'error');
            }
        }
        
        async function toggleBlock(userId, block) {
            try {
                const action = block ? 'block' : 'unblock';
                const res = await fetch('/api/admin/block', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action})
                });
                
                if (res.ok) {
                    showNotification(block ? 'ðŸš« Utilisateur bloquÃ©' : 'âœ… Utilisateur dÃ©bloquÃ©');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const data = await res.json();
                    showNotification(`âŒ Erreur: ${data.error}`, 'error');
                }
            } catch (e) {
                showNotification(`âŒ Erreur rÃ©seau`, 'error');
            }
        }
        
        async function logout() {
            await fetch('/api/logout', {method: 'POST'});
            window.location = '/login';
        }
        
        // Stats
        function updateStats() {
            const rows = document.querySelectorAll('tbody tr');
            let active = 0;
            let expired = 0;
            
            rows.forEach(row => {
                const timeCell = row.querySelector('.time-remaining');
                if (timeCell) {
                    if (timeCell.textContent.includes('EXPIRÃ‰') || timeCell.textContent.includes('Non abonnÃ©')) {
                        expired++;
                    } else {
                        active++;
                    }
                }
            });
            
            document.getElementById('totalUsers').textContent = rows.length;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('expiredUsers').textContent = expired;
        }
        
        // Init
        updateTimers();
        updateStats();
        setInterval(updateTimers, 60000);
        
        // RafraÃ®chir les donnÃ©es toutes les 30 secondes
        setInterval(async () => {
            try {
                const res = await fetch('/api/admin/users');
                if (res.ok) {
                    const data = await res.json();
                    // Vous pouvez mettre Ã  jour le tableau ici sans recharger
                }
            } catch (e) {
                console.error('Erreur refresh:', e);
            }
        }, 30000);
    </script>
</body>
</html>
